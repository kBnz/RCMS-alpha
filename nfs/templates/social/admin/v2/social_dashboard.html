{rcms_include file="management/header.html"}
{rcms_include file="menu/admin/subnavi.html"}

{literal}
<style type="text/css">
#main_contents.name{
    padding:5px 10px;
}
#main_contents.message{
    border-bottom:solid 1px #a0a0a0;
    padding:5px 30px;
}

#users_field{
    background-color:#ffffff;
    height:500px;
    width:400px;
    float:left;
    overflow-y:scroll;
    overflow-x:hidden;
    padding:0px;
}
#posts_field{
    background-color:#ffffff;
    height:500px;
    width:600px;
    float:left;
    overflow-y:scroll;
    overflow-x:hidden;
    padding:0px;
}

.loading{
    background-image: url("{/literal}{$smarty.const.ROOT_URL}{literal}/images/modules/social/loading_w.gif");
    background-position: center;
    background-repeat:no-repeat;
    height:100px;
    margin:0;
    padding:70px 10px 10px 10px;
}

.user{
    width:100%;
    border-bottom: 1px solid #e0e0e0;
    height:25px;
    overflow: hidden;
    padding:10px;
    margin:0;
    float:left;
}

.user .profile_pic,
.post .profile_pic{
    width:20px;
    height:20px;
    float:left;
}

.user .user_name{
    font-size: 13px;
}

.post{
    border-bottom: 1px solid #e0e0e0;
    overflow: hidden;
    padding:10px 10px 10px 10px;
    margin:0;
}

.post .status_undone{
    background-image: url("{/literal}{$smarty.const.ROOT_URL}{literal}/images/modules/social/badge.png");
    background-position: center;
    background-repeat:no-repeat;
    width:20px;
    height:20px;
    margin:0;
    float:left;
}
.post .status_done{
    border:1px dotted #c0c0c0;
    width:20px;
    height:20px;
    margin:0;
    float:left;
}

.bookmark_on{
    background-image: url("{/literal}{$smarty.const.ROOT_URL}{literal}/images/modules/social/flag.png");
    background-position: center;
    background-repeat:no-repeat;
    width:20px;
    height:20px;
    margin:0;
    float:left;
}
.bookmark_off{
    border:1px dotted #f0f0f0;
    width:20px;
    height:20px;
    margin:0;
    float:left;
}

.bookmark_wait,
.status_wait
{
    background-image: url("{/literal}{$smarty.const.ROOT_URL}{literal}/images/modules/social/loading_sw.gif");
    background-position: center;
    background-repeat:no-repeat;
    width:20px;
    height:20px;
    margin:0;
    float:left;
}

.comments{
    background-color: #dee4ea;
}
.comment{
    border-bottom:1px solid #c3cdda;
    padding:5px;
}

#publish_field{
    height:100px;
    width:520px;
    margin:20px;
    padding:0px;
    background-color:#ffffff;
    border: solid 1px #a0a0a0;
    clear:both;
}

#publish_message{
    width:280px;
    height:80px;
    float:left;
    border:0px;
    padding:10px;
    max-width:280px;
    max-height:80px;
}

#publish_options{
    width:200px;
    height:100%;
    border-left:1px solid #a0a0a0;
    float:left;
}

#publish_lang_selector, #publish_button{
    clear:both;
    margin:10px;
}

{* feedピッカー *}
#feed_picker_view{
    clear: both;
    position: relative;
    background-color: #ffffff;
    border: solid 1px #e0e0e0;
    -moz-border-radius: 5px;
    border-radius: 5px;
    height:100px;
    overflow: hidden;
    width:100%;
}

#feed_picker_view>ul{
    position: absolute;
    top:0px;
    left:40px;
    clear: both;
    list-style-type: none;
    display:inline;
    overflow: hidden;
    width:9999px;
}

.feed_picker{
    position:relative;
    float: left;
    width: 130px;
    height: 200px;
    padding: 10px;
    margin: 0px;
    text-align: center;
}

.selected_feed{
    color:#ffffff;
    background: rgb(181,189,200); /* Old browsers */
    background: -moz-linear-gradient(top, rgba(181,189,200,1) 0%, rgba(71,86,104,1) 100%); /* FF3.6+ */
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(181,189,200,1)), color-stop(100%,rgba(71,86,104,1))); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(top, rgba(181,189,200,1) 0%,rgba(71,86,104,1) 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(top, rgba(181,189,200,1) 0%,rgba(71,86,104,1) 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(top, rgba(181,189,200,1) 0%,rgba(71,86,104,1) 100%); /* IE10+ */
    background: linear-gradient(top, rgba(181,189,200,1) 0%,rgba(71,86,104,1) 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#b5bdc8', endColorstr='#475668',GradientType=0 ); /* IE6-9 */
}

@-webkit-keyframes rotateArea {
    0% {-webkit-transform: rotate(0deg);}
    100% {-webkit-transform: rotate(360deg);}
}

.update_status_processing{
    background-image: url("{/literal}{$smarty.const.ROOT_URL}{literal}/images/modules/social/updating.png");
    -webkit-animation-name: rotateArea;
    -webkit-animation-duration: 1.5s;
    -webkit-animation-timing-function: linear;
    -webkit-animation-iteration-count: infinite;
    background-position: center;
    background-repeat:no-repeat;
    z-index:10;
    width :130px;
    height: 50px;
    margin: 0px;
    position: absolute;
}
.update_status{
    z-index:10;
    width :130px;
    height: 50px;
    margin: 0px;
    position: absolute;
}



.feed_picker img{
    max-width:50px;
    max-height:50px;
    z-index:1;
}

.feed_picker h4{
    position: absolute;
    top:60px;
    left:0px;
    width:130px;
    padding:10px;
    font-size: 12px;
    text-align: center;
}

h4.short{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    -webkit-text-overflow: ellipsis;
    -o-text-overflow: ellipsis;
}


.feed_picker .details{
    display:none;
    position: absolute;
    width:100%;
    top:95px;
    left:0px;
    padding:0px;
    text-align: center;
    border-left :1px solid #e0e0e0;
    height: 90px;
    font-size: 10px;
}

.feed_picker:first-child .details{
    border :0px;
}

#toggle_feed_detail_btn{
    height:10px;
    background-color: #e0e0e0;
    width:100%;
    position: absolute;
    z-index: 2;
    bottom:0px;
    left:0px;
    text-align: center;
    font-size: 8px;
    color:#ffffff;
}
#toggle_feed_detail_btn:hover{
    background-color: #d0d0d0;
}

#scroll_feed_left_btn{
    height:200px;
    width:40px;
    position: absolute;
    z-index: 1;
    top:0px;
    left:0px;
    text-align: center;
    padding-top: 40px;
    font-size: 20px;
    color:#909090;
    -moz-border-radius: 5px;
    border-radius: 5px;

    text-shadow: 0px 0px 3px #ffffff;
    background: -moz-linear-gradient(left,  rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); /* FF3.6+ */
    background: -webkit-gradient(linear, left top, right top, color-stop(0%,rgba(255,255,255,1)), color-stop(100%,rgba(255,255,255,0))); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(left,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(left,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(left,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* IE10+ */
    background: linear-gradient(left,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#00ffffff',GradientType=1 ); /* IE6-9 */
}

#scroll_feed_right_btn{
    height:200px;
    width:40px;
    position: absolute;
    z-index: 1;
    top:0px;
    right:0px;
    text-align: center;
    padding-top: 40px;
    font-size: 20px;
    color:#909090;
    -moz-border-radius: 5px;
    border-radius: 5px;

    text-shadow: 0px 0px 3px #ffffff;
    background: -moz-linear-gradient(left,  rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%); /* FF3.6+ */
    background: -webkit-gradient(linear, left top, right top, color-stop(0%,rgba(255,255,255,0)), color-stop(100%,rgba(255,255,255,1))); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(left,  rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(left,  rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(left,  rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%); /* IE10+ */
    background: linear-gradient(left,  rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#00ffffff', endColorstr='#ffffff',GradientType=1 ); /* IE6-9 */
}
#scroll_feed_left_btn:hover{
    background: -moz-linear-gradient(left,  rgba(240,240,240,1) 0%, rgba(240,240,240,0) 100%); /* FF3.6+ */
    background: -webkit-gradient(linear, left top, right top, color-stop(0%,rgba(240,240,240,1)), color-stop(100%,rgba(240,240,240,0))); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(left,  rgba(240,240,240,1) 0%,rgba(240,240,240,0) 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(left,  rgba(240,240,240,1) 0%,rgba(240,240,240,0) 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(left,  rgba(240,240,240,1) 0%,rgba(240,240,240,0) 100%); /* IE10+ */
    background: linear-gradient(left,  rgba(240,240,240,1) 0%,rgba(240,240,240,0) 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f0f0f0', endColorstr='#00f0f0f0',GradientType=1 ); /* IE6-9 */
}
#scroll_feed_right_btn:hover{
    background: -moz-linear-gradient(left,  rgba(240,240,240,0) 0%, rgba(240,240,240,1) 100%); /* FF3.6+ */
    background: -webkit-gradient(linear, left top, right top, color-stop(0%,rgba(240,240,240,0)), color-stop(100%,rgba(240,240,240,1))); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(left,  rgba(240,240,240,0) 0%,rgba(240,240,240,1) 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(left,  rgba(240,240,240,0) 0%,rgba(240,240,240,1) 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(left,  rgba(240,240,240,0) 0%,rgba(240,240,240,1) 100%); /* IE10+ */
    background: linear-gradient(left,  rgba(240,240,240,0) 0%,rgba(240,240,240,1) 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#00f0f0f0', endColorstr='#f0f0f0',GradientType=1 ); /* IE6-9 */
}

</style>
{/literal}

<h3>ソーシャル ダッシュボード</h3>

<div class="clear"></div>

<div class="main_contents">
<div class="list_main">

{*$list|@debug_print_var*}

{* feedピッカー *}
<div id="feed_picker_view">
    <ul id="feed_picker_container">
        {foreach from=$list item=item name=feed}
            {*変数の設定*}
            {if $item.picture}
                {assign var="thumbnail_url" value=$item.picture}
            {elseif $item.icon}
                {assign var="thumbnail_url" value=$item.icon}
            {else}
                {assign var="thumbnail_url" value=""}
            {/if}
            <li id="feed_picker_{$item.page_id}" class="feed_picker{if $smarty.foreach.feed.first} selected_feed{/if}">
                <input type="hidden" class="fb_data" value='{ldelim}"pk":"{$item.social_facebook_watcher_id}","id":"{$item.page_id}"{rdelim}' />
                <div class="update_status"></div>
                <img src="{$thumbnail_url}">
                <h4 class="short">{$item.page_name}</h4>
                <div class="details">
                    <ul>
                        {if $item.likes}
                        <li>
                            {$item.likes} Likes.
                        </li>
                        {/if}
                        {if $item.privacy}
                        <li>
                            公開レベル:{$item.privacy}
                        </li>
                        {/if}
                        {if $item.link}
                        <li>
                            <a href="{$item.link}" target="_blank">ページを表示</a>
                        </li>
                        {/if}
                        {if $item.social_facebook_watcher_id}
                        <li>
                            <a href="/management/social/facebook_watcher_edit/id={$item.social_facebook_watcher_id}">設定/削除</a>
                        </li>
                        {/if}
                        <li>
                            更新開始<br>{$item.update_process_started|date_format:"%m/%d %H:%M:%S"}
                        </li>
                    </ul>
                    <p>最終更新<br>{$item.last_updated|date_format:"%m/%d %H:%M:%S"}</p>
                </div>
            </li>
        {/foreach}
        {if $smarty.const.SOCIAL_FB_WATCHER_LIMIT > $list|@count}
            <li>
                <br><br>
                <a href="/management/social/facebook_watcher_edit/">新規追加</a>
            </li>
        {/if}

    </ul>
    <div id="scroll_feed_left_btn">
        &laquo;
    </div>
    <div id="scroll_feed_right_btn">
        &raquo;
    </div>
    <div id="toggle_feed_detail_btn">
        ▼
    </div>
</div>
{* feedピッカー ここまで *}


{* 開発用フィールド *}
<div id="development_view">
    <table>
        <tr>
            <th>Feed</th>
            <td>
                <select id="feed_selector">
                {foreach from=$list item=item}
                <option value='{ldelim}"pk":"{$item.social_facebook_watcher_id}","id":"{$item.page_id}"{rdelim}'>{$item.page_name}</option>
                {/foreach}
                </select>
                <button id="draft_update_btn">データを更新 Draft</button>
                <button id="update_btn">データを更新</button>
                <button id="get_update_process_status_btn">更新状況</button>
            </td>
        </tr>
        <tr>
            <th>CSVダウンロード</th>
            <td>
                <button id="get_daily_posts_csv_btn">日別投稿数</button>
                <button id="get_feed_csv_btn">Feed マスタ</button>
            </td>
        </tr>
        <tr>
            <th>XLSXダウンロード</th>
            <td>
                <button id="get_feed_xls_btn">Feed,User マスタ</button>
            </td>
        </tr>
    </table>
    
    <!-- API_ACCESS_LOG -->
    {literal}
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
      
      function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Date');
        data.addColumn('number', 'Access count');
        data.addColumn('number', 'Process duration');
        data.addRows([
    {/literal}
        {foreach from=$api_access_summary item=data name=api_access_summary}
            ['{$data.since|date_format:"%m/%d"}',{$data.access_count} ,{$data.duration}]{if $smarty.foreach.api_access_summary.last}{else},{/if}
        {/foreach}
    {literal}
        ]);

        var options = {
          width: 1000, height: 300,
          title: 'Graph API access log summary'
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
    </script>
    {/literal}
    <div id="chart_div"><a href="javascript:drawChart();">Graph API アクセスログを表示</a></div>
    
</div>
{* 開発用フィールド ここまで *}




{*
<div id="publish_field">
    <textarea id="publish_message"></textarea>
    <div id="publish_options">
        <select id="publish_lang_selector">
            <option value="">全員に公開</option>
            <option value="ja">日本語</option>
            <option value="en">英語</option>
            <option value="fr">フランス語</option>
            <option value="de">ドイツ語</option>
            <option value="es">スペイン語</option>
            <option value="ko">韓国語</option>
            <option value="zh">中国語</option>
            <option value="ru">ロシア語</option>
            <option value="it">イタリア語</option>
        </select>
        <br>
        <button id="publish_button">投稿</button>
    </div>
</div>
<div style="clear:both;" />
*}

{*
<div id="feeds_field">
</div>
*}

<div id="users_field">
</div>
<div id="posts_field">
</div>


</div>
</div>

{literal}
<!-- テンプレートエンジン,jQueryUIの読み込み -->
<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>
<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.ui/1.8.10/jquery-ui.js"></script>

<!-- テンプレートの定義   feed_picker-->
<script id="feed_template" type="text/x-jquery-tmpl">
</script>


<!-- テンプレートの定義   user-->
<script id="loading_template" type="text/x-jquery-tmpl">
    <div class="loading">
    </div>
</script>

<!-- テンプレートの定義   user-->
<script id="user_template" type="text/x-jquery-tmpl">
    <div class="user">
        <input type="hidden" class="user_id" value="${user_id}" />
        <input type="hidden" class="feed_id" value="${to_id}" />
        <input type="hidden" class="target" value="user" />
        <div id="status_${user_id}" class="status_{{if status == 1}}done{{else}}undone{{/if}}"> </div>
        <div id="bookmark_${user_id}" class="bookmark_{{if bookmark == 1}}on{{else}}off{{/if}}"> </div>
        <img class="profile_pic" src="http://graph.facebook.com/${user_id}/picture/" />
        <div class="user_name">${name}</div>
    </div>
</script>

<!-- テンプレートの定義   post-->
<script id="post_template" type="text/x-jquery-tmpl">
    <div class="post">
        <input type="hidden" class="user_id" value="${user_id}" />
        <input type="hidden" class="feed_id" value="${to_id}" />
        <input type="hidden" class="post_id" value="${post_id}" />
        <input type="hidden" class="target" value="post" />
        <div id="status_${post_id}" class="status_{{if status == 1}}done{{else}}undone{{/if}}"> </div>
        <div id="bookmark_${post_id}" class="bookmark_{{if bookmark == 1}}on{{else}}off{{/if}}"> </div>
        <img class="profile_pic" src="http://graph.facebook.com/${user_id}/picture/" />
        <div class="user_name">${user_name}</div>
        <div class="created_time">${created_time}</div>
        <div class="content">
            {{if thumbnail != '' && link != ''}}
                <a class="link" href="${link}">
                <img class="thumbnail" src="${thumbnail}">
                </a>
            {{else link != ''}}
                <a class="link" href="${link}">${link}</a>
            {{/if}}
            <p class="msg">${message}</p>
        </div>
        <div class="post_info">
            <div class="likes_count">Likes : ${likes_count}</div>
            <div class="comments_count">Comments : ${comments_count}</div>
        </div>
        {{if comments}}
            <div>コメントを表示</div>
            <div class="comments">
            {{each(i, comment) comments}}
                <div class="comment">
                    <p class="msg">${comment.message} </p>
                    <div class="user_name">${comment.user_name}</div>
                    <div class="created_time">${comment.created_time}</div>
                </div>
            {{/each}}
            </div>
        {{/if}}
    </div>
</script>


<script type="text/javascript">

// オブジェクトからオブジェクトのインスタンス（コピー）を作成する関数
createObject.f = function(){};
function createObject(o) {
    var f = createObject.f, i, len, n, prop;
    f.prototype = o;
    n = new f;
    for (i=1, len=arguments.length; i<len; ++i){
        for (prop in arguments[i]){
            n[prop] = arguments[i][prop];
        }
    }
    return n;
}

j$(document).ready(function(){
    SocialDashboard.init();
});

var SocialDashboard = {
    
    MEMBER_LIST : null,
    FEED_DATA   : null,
    CURRENT_FEED: null,

    // 使用するオブジェクトを定義
    usersField               : j$("#users_field"),
    postsField               : j$("#posts_field"),
    draftUpdateBtn           : j$("#draft_update_btn"),
    updateBtn                : j$("#update_btn"),
    feedSelector             : j$("#feed_selector"),
    getFeedCsvBtn            : j$("#get_feed_csv_btn"),
    getMemberCsvBtn          : j$("#get_member_csv_btn"),
    getDailyPostsCsvBtn      : j$("#get_daily_posts_csv_btn"),
    getFeedXlsBtn            : j$("#get_feed_xls_btn"),
    statusDoneBtn            : j$(".status_done"),
    statusUndoneBtn          : j$(".status_undone"),
    bookmarkOnBtn            : j$(".bookmark_on"),
    bookmarkOffBtn           : j$(".bookmark_off"),
    
    getUpdateProcessStatusBtn: j$("#get_update_process_status_btn"),
    
    
    // 投稿関連
    publishBtn               : j$("#publish_button"),
    publishMsgTextarea       : j$("#publish_message"),
    publishLangSelector      : j$("#publish_lang_selector"),
    
    // feedピッカー関連
    feedPicker               : j$(".feed_picker"),
    toggleFeedDetailBtn      : j$("#toggle_feed_detail_btn"),
    scrollFeedRightBtn       : j$("#scroll_feed_right_btn"),
    scrollFeedLeftBtn        : j$("#scroll_feed_left_btn"),
    feedPickerContainer      : j$("#feed_picker_container"),
    feedPickerView           : j$("#feed_picker_view"),

    // テンプレート
    postTmpl                 : j$("#post_template"),
    userTmpl                 : j$("#user_template"),
    loadingTmpl              : j$("#loading_template"),

    // 初期化
    init:function(){
        
        console.log("hello");
        
        //イベントリスナーを登録
        var self = this;
        
        //ステータス取得ボタン
        SocialDashboard.getUpdateProcessStatusBtn.click(SocialDashboard.getUpdateProcessStatus);
        
        SocialDashboard.updateBtn.click(SocialDashboard.updateData); //更新ボタン
        SocialDashboard.draftUpdateBtn.click(SocialDashboard.draftUpdateData);
        
        SocialDashboard.getDailyPostsCsvBtn.click(SocialDashboard.downloadDailyPostsReportCsv); //DLボタン
        SocialDashboard.getFeedCsvBtn.click(SocialDashboard.downloadFeedReportCsv);
        SocialDashboard.getFeedXlsBtn.click(SocialDashboard.downloadFeedReportXls);

        SocialDashboard.statusUndoneBtn.live("click",SocialDashboard.setStatus); //フラグ系ボタン
        SocialDashboard.statusDoneBtn.live("click",SocialDashboard.setStatus); 
        SocialDashboard.bookmarkOnBtn.live("click",SocialDashboard.setBookmark); 
        SocialDashboard.bookmarkOffBtn.live("click",SocialDashboard.setBookmark); 
        
        SocialDashboard.publishBtn.click(SocialDashboard.publish); // 投稿ボタン

        SocialDashboard.feedPicker.click(SocialDashboard.selectFeed); // feed選択
        SocialDashboard.toggleFeedDetailBtn.click(SocialDashboard.toggleFeedDetail); // feed詳細表示
        SocialDashboard.scrollFeedLeftBtn.click(SocialDashboard.scrollFeedLeft); // feedを左にスクロール
        SocialDashboard.scrollFeedRightBtn.click(SocialDashboard.scrollFeedRight); // feedを左にスクロール
        
                
        // 各種読み込み
        SocialDashboard.getUsers();
        SocialDashboard.getPosts();
        
        SocialDashboard.getUpdateProcessStatus();

    },
    

// -----Feedピッカー-----    
    // feecの選択
    selectFeed:function(){
        SocialDashboard.feedPicker.removeClass("selected_feed");
        j$(this).addClass("selected_feed");
        
        // 値を設定
        SocialDashboard.feedSelector.val(j$(".fb_data",this).val());

        // 各種読み込み
        SocialDashboard.getUsers();
        SocialDashboard.getPosts();
    },
    
    // feedの詳細をトグル
    toggleFeedDetail:function(){

        if( j$(".details",j$(this).parent()).css("display") == "none" ){
            j$(".details",j$(this).parent()).show()
            j$(this).parent().animate({height: "200px"},{duration: "fast", easing: "linear"});
            j$(this).html("▲");
        }else{
            j$(this).parent().animate({height: "100px"},{duration: "fast", easing: "linear",complete:function(){j$(".details",j$(this).parent()).hide();}});
            j$(this).html("▼");
        }
    },
    
    scrollFeedRight:function(){
        
        var x = parseInt(SocialDashboard.feedPickerContainer.css("left").match(/[0-9\-]+/g)[0]);
        var rightEnd = SocialDashboard.feedPickerView.width() - (SocialDashboard.feedPicker.size() * SocialDashboard.feedPicker.outerWidth()) - 40 -120;
        x = x - (SocialDashboard.feedPickerView.width()*0.7);
        if( x < rightEnd){x=rightEnd;}
        SocialDashboard.feedPickerContainer.animate({"left": x + "px"},{duration: "fast", easing: "linear"});

    },

    scrollFeedLeft:function(){
        
        var x = parseInt(SocialDashboard.feedPickerContainer.css("left").match(/[0-9\-]+/g)[0]);
        x = x + (SocialDashboard.feedPickerView.width()*0.7);
        if( x > 40){x=40;}
        SocialDashboard.feedPickerContainer.animate({"left": x + "px"},{duration: "fast", easing: "linear"});
    
    },

    //現在選択しているfeedのJSON文字列をオブジェクトで返す
    getCurrentFeed:function(){
        var return_val = eval("(" + SocialDashboard.feedSelector.val() + ")");
        return return_val;
    },
    
// -----Ajax用関数群-----
    //feedのユーザー一覧を取得する
    getUsers:function(feed_id){

        if(!feed_id){
            var feed = SocialDashboard.getCurrentFeed();
            feed_id = feed.id;
        }

        // loadingを表示
        SocialDashboard.usersField.empty()
        SocialDashboard.usersField.prepend(SocialDashboard.loadingTmpl.tmpl());

        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/get_data/",
            data: {"feed_id":feed_id,"target":"users"},
            success: SocialDashboard.onSuccessGetUsers
        });
    
    },
    onSuccessGetUsers:function(response){
//console.log(response);
        var result = eval("(" + response + ")");
        SocialDashboard.showUsers(result);
    },


    // feedのpost一覧を取得する
    getPosts:function(feed_id){

        if(!feed_id){
            var feed = SocialDashboard.getCurrentFeed();
            feed_id = feed.id;
        }
        
        // loadingを表示
        SocialDashboard.postsField.empty()
        SocialDashboard.postsField.prepend(SocialDashboard.loadingTmpl.tmpl());

        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/get_data/",
            data: {"feed_id":feed_id,"target":"posts"},
            success: SocialDashboard.onSuccessGetPosts
        });
    
    },
    onSuccessGetPosts:function(response){
//console.log(response);

        var result = eval("(" + response + ")");
//console.log(result);
        
        SocialDashboard.showPosts(result);

    },

    // statusを変更する
    setStatus:function(){
    
        var val    = (j$(this).attr("class") == "status_undone") ? 1 : 0;
        var postId = j$(".post_id",j$(this).parent()).val();
        var userId = j$(".user_id",j$(this).parent()).val();
        var feedId = j$(".feed_id",j$(this).parent()).val();
        var target = j$(".target",j$(this).parent()).val();
        
        j$(this).removeClass("status_undone");
        j$(this).removeClass("status_done");
        j$(this).addClass("status_wait");

        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/set_ext_data/",
            data: {"id"     :postId,
                   "feed_id":feedId,
                   "target" :target,
                   "type"   :"status",
                   "val"    :val
                   },
            success: SocialDashboard.onSuccessSetStatus
        });
    },
    
    onSuccessSetStatus:function(response){
    
        var result = eval("(" + response + ")");
        
        if(result.result==1){
            var className = result.val==1 ? "status_done" : "status_undone";
        }else{
            var className = result.val==1 ? "status_undone" : "status_done";
        }
        var selector = "#" + result.type + "_" + result.id;
        j$(selector).removeClass("status_wait");
        j$(selector).addClass(className);

    
    },

    // bookmarkを変更する
    setBookmark:function(){
        
        var target = j$(".target",j$(this).parent()).val();
        var feedId = j$(".feed_id",j$(this).parent()).val();
        var id = (target=="user") ? j$(".user_id",j$(this).parent()).val() : j$(".post_id",j$(this).parent()).val();
        var val    = (j$(this).attr("class") == "bookmark_off") ? 1 : 0;
        
        j$(this).removeClass("bookmark_on");
        j$(this).removeClass("bookmark_off");
        j$(this).addClass("bookmark_wait");

        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/set_ext_data/",
            data: {"id"     :id,
                   "feed_id":feedId,
                   "target" :target,
                   "type"   :"bookmark",
                   "val"    :val
                   },
            success: SocialDashboard.onSuccessSetBookamrk
        });
    },
    
    onSuccessSetBookamrk:function(response){
    
        var result = eval("(" + response + ")");
        
        if(result.result==1){
            var className = result.val==1 ? "bookmark_on" : "bookmark_off";
        }else{
            var className = result.val==1 ? "bookmark_off" : "bookmark_on";
        }
        var selector = "#" + result.type + "_" + result.id;
        j$(selector).removeClass("bookmark_wait");
        j$(selector).addClass(className);

    
    },

    // 投稿する
    publish:function(){
    
        var msg       = SocialDashboard.publishMsgTextarea.val();
        var locale    = SocialDashboard.publishLangSelector.val();
        var feed      = SocialDashboard.getCurrentFeed();
        
        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/post/",
            data: {"feed_id"    :feed.id,
                   "msg"        :msg,
                   "locales"     :locale,
                   "comment_to" :""
                   },
            success: SocialDashboard.onSuccessPublish
        });

    
    },
    
    onSuccessPublish:function(response){
        alert(response);
    },

// -----Ajax用関数群ここまで-----

// -----表示系関数群ここから-----

    // ポストの表示
    showPosts:function(posts){

        SocialDashboard.postsField.empty();
        SocialDashboard.postsField.html(SocialDashboard.postTmpl.tmpl(posts));
    },
    
    // ユーザーの表示
    showUsers:function(users){

        SocialDashboard.usersField.empty();
        SocialDashboard.usersField.html(SocialDashboard.userTmpl.tmpl(users));
    },


// -----表示系関数群ここまで-----

// -----ダウンロード用関数群-----
    // 投稿数デイリーレポートをダウンロード
    downloadDailyPostsReportCsv:function(){
        var feed = SocialDashboard.getCurrentFeed();
        window.location.href = "{/literal}{$smarty.const.ROOT_SSL_URL}{literal}/direct/social/fb_daily_posts_report_csv_downloader/id=" + feed.id;
        
    },

    // FeedのCSVをダウンロード
    downloadFeedReportCsv:function(){
        var feed = SocialDashboard.getCurrentFeed();
        window.location.href = "{/literal}{$smarty.const.ROOT_SSL_URL}{literal}/direct/social/fb_feed_report_csv_downloader/id=" + feed.id;
    },
    
    // FeedのXLSをダウンロード
    downloadFeedReportXls:function(){
        var feed = SocialDashboard.getCurrentFeed();
        window.location.href = "{/literal}{$smarty.const.ROOT_SSL_URL}{literal}/direct/social/fb_feed_report_xls_downloader/id=" + feed.id;
    },

// -----ダウンロード用関数群ここまで-----


    // 更新プロセスのステータスを取得
    getUpdateProcessStatus:function(){
        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/fb_update_process_status/",
            success: SocialDashboard.onSuccessGetUpdateProcessStatus
        });
    },
    onSuccessGetUpdateProcessStatus:function(response){
        var processing = eval("(" + response + ")");
        console.log(processing);
        j$(".feed_picker .update_status").each(function(){j$(this).removeClass("update_status_processing");});
        for(var i in processing){
            console.log(processing[i].feed_name);
            var selector = "#feed_picker_" + processing[i].feed_id + " .update_status";
            j$(selector).addClass("update_status_processing");
        }
        
        if(processing.length > 0){
            setTimeout("SocialDashboard.getUpdateProcessStatus()",3000);
        }

    },
    
    // DBの更新
    updateData:function(){

        // loadingを表示
        /*
        SocialDashboard.usersField.prepend(SocialDashboard.loadingTmpl.tmpl());
        SocialDashboard.postsField.prepend(SocialDashboard.loadingTmpl.tmpl());

        SocialDashboard.updateBtn.html("更新中 データ量により数分の時間が掛かります。");
        SocialDashboard.draftUpdateBtn.attr("disabled","disabled");
        SocialDashboard.updateBtn.attr("disabled","disabled");
        */
        var feed = SocialDashboard.getCurrentFeed();
        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/fb_update_process_starter/",
            data: {"pk":feed.pk,"id":feed.id},
            success: SocialDashboard.onSuccessUpdateData
        });
        
    },
    onSuccessUpdateData:function(response){
        SocialDashboard.getUpdateProcessStatus();

        /*
        SocialDashboard.updateBtn.html("データを更新");
        SocialDashboard.draftUpdateBtn.removeAttr("disabled");
        SocialDashboard.updateBtn.removeAttr("disabled");

        var html = '<div class="loading"></div>';
        SocialDashboard.postsField.html(html);
        SocialDashboard.usersField.html(html);
        SocialDashboard.getUsers();
        SocialDashboard.getPosts();
        */
    },
    

    
    // DBの更新 (draft)
    draftUpdateData:function(){
        // loadingを表示
        /*
        SocialDashboard.usersField.prepend(SocialDashboard.loadingTmpl.tmpl());
        SocialDashboard.postsField.prepend(SocialDashboard.loadingTmpl.tmpl());

        SocialDashboard.draftUpdateBtn.html("更新中 データ量により数分の時間が掛かります。");
        SocialDashboard.draftUpdateBtn.attr("disabled","disabled");
        SocialDashboard.updateBtn.attr("disabled","disabled");
        */
        
        var feed = SocialDashboard.getCurrentFeed();
        j$.ajax({
            type: "POST",
            async: true,
            url: "/direct/social/fb_update_process_starter/",
            data: {"pk":feed.pk,"id":feed.id,"draft_mode":1},
            success: SocialDashboard.onSuccessDraftUpdateData
        });
        
    },
    onSuccessDraftUpdateData:function(response){

        SocialDashboard.getUpdateProcessStatus();
        
        /*
        SocialDashboard.draftUpdateBtn.html("データを更新 Draft");
        SocialDashboard.draftUpdateBtn.removeAttr("disabled");
        SocialDashboard.updateBtn.removeAttr("disabled");

        var html = '<div class="loading"></div>';
        SocialDashboard.postsField.html(html);
        SocialDashboard.usersField.html(html);
        SocialDashboard.getUsers();
        SocialDashboard.getPosts();
        */
    },

    
}

</script>
{/literal}